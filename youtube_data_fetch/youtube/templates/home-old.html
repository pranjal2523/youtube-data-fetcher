{% extends 'base.html' %}

{% block title %}Home{% endblock %}

{% block content %}
<div class="container mt-5">
    <div class="jumbotron text-center">
        <h1>Welcome to the Home Page</h1>
        <p class="lead">Fetch videos and comments from a YouTube channel.</p>
        
        <div class="row justify-content-center m-2">
            <div class="col-6">
                <input type="text" class="form-control mb-2" name="youtube_url" id="youtube_url" placeholder="Enter YouTube URL" />
            </div>
            <div class="col-4">
                <input type="number" class="form-control mb-2" name="comment_count" id="comment_count" placeholder="Number of Comments (Default: 100)" min="1" />
            </div>
        </div>
        <div class="row">
            <div class="col-12" id="error_message" style="color: red;"></div>
        </div>
        <div class="row justify-content-center">
            <div class="col-6">
                <button class="btn btn-primary btn-lg" id="fetch_data_button">Fetch Data</button>
            </div>
        </div>

        <div class="row justify-content-center mt-4" id="download_buttons" style="display: none;">
            <div class="col-5">
                <button class="btn btn-success btn-lg" id="download_video_button">Download Videos</button>
            </div>
            <div class="col-5">
                <button class="btn btn-info btn-lg" id="download_comment_button">Download Comments</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block script %}
<script>

    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                // Check if this cookie string begins with the desired name
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    async function fetchYouTubeData() {
        const youtubeUrl = document.getElementById('youtube_url').value.trim();
        let commentCount = document.getElementById('comment_count').value.trim();
        document.getElementById('error_message').innerHTML = '';

        // Set default comment count if not provided
        if (!commentCount) {
            commentCount = 100;
        }

        // Validate input
        if (!youtubeUrl) {
            document.getElementById('error_message').innerHTML = 'Please enter a valid YouTube URL!';
            return;
        }

        const apiUrl = '/fetch-youtube-data/'; // Replace with your actual API endpoint

        // Create the request body
        const requestBody = {
            youtube_url: youtubeUrl,
            comment_count: commentCount
        };
        const fetchButton = document.getElementById('fetch_data_button');
        fetchButton.disabled = true;
        try {
            const response = await fetch(apiUrl, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken') // Add CSRF token here
                },
                body: JSON.stringify(requestBody)
            });

            // Check if the response is okay (status code in the range 200-299)
            if (!response.ok) {
                throw new Error(`HTTP error! Status: ${response.status}`);
            }

            // Parse the JSON response
            const data = await response.json();

            // Show download buttons
            document.getElementById('download_buttons').style.display = 'flex';
            document.getElementById('download_video_button').onclick = () => {
                window.location.href = data.video_file; // Navigate to video file URL
            };
            document.getElementById('download_comment_button').onclick = () => {
                window.location.href = data.comment_file; // Navigate to comment file URL
            };

            // Optionally, display the file links in console
            console.log('Video File:', data.video_file);
            console.log('Comment File:', data.comment_file);
        } catch (error) {
            console.error('Error fetching YouTube data:', error);
            document.getElementById('error_message').innerHTML = 'Failed to fetch data. Please try again later.';
        } finally {
            // Re-enable the fetch button regardless of success or failure
            fetchButton.disabled = false;
        }
    }

    // Attach event listener to the button
    document.getElementById('fetch_data_button').addEventListener('click', fetchYouTubeData);
</script>
{% endblock %}
